<html>
<head>
<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jqGrid/ui.jqgrid-4.5.4.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/jquery.jqGrid-4.5.4.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/grid.locale-all.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<script type="text/javascript">
    systemDictionary = {
        "PING adapter settings": {"en": "PING adapter settings", "de": "PING Adapter-Einstellungen", "ru": "Настройки драйвера PING"}
    };

    function showStep(step) {
        currentStep = step;
        if (steps[step]) steps[step]();
        var $container = $('#container');
        $container.find('.wizard-page').hide();
        $('.wizard-page[data-step="' + step + '"]').show();

    }
    var currentStep = null;
    var newInstances;
    var existingInstances;
    var devices;

    function step0() {
        var $step0 = $('#step0_discover');
        $('#step0_help').show();

        $step0.button({
            label:  $step0.data('title'),
            icons: {
                primary: ' ui-icon-search'
            }
        }).click(function () {
            $step0.button('disable');
            $('#step0_help').hide();
            sendTo(null, 'browse', null, function (result) {
                $('#step0_text').hide();
                $('#step0_progressbar').hide();
                $step0.button('enable');
                if (result.error) {
                    showMessage(result.error, _('Error'), 'alert');
                } else {
                    newInstances = result.newInstances;
                    devices = result.devices;
                    showStep(currentStep + 1);
                }
            });
        });

        $('#step0_next').button('disable');

        getIsAdapterAlive(function (isAlive) {
            if (!isAlive) $step0.button('disable');
        });
        socket.emit('getObject', 'system.discovery', function (err, obj) {
            if (obj && obj.native.newInstances) {
                newInstances = obj.native.newInstances;
            }
            if (obj && obj.native.devices) {
                devices = obj.native.devices;
            }
            var found = false;
            if (devices) {
                for (var d in devices) {
                    if (devices.hasOwnProperty(d)) {
                        found = true;
                        break;
                    }
                }
            }
            if (newInstances) {
                for (var n in newInstances) {
                    if (newInstances.hasOwnProperty(n)) {
                        found = true;
                        break;
                    }
                }
            }
            if (found) {
                $('#step0_next').button('enable');
            }
        });
    }

    function getExistingInstances(callback) {
        socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.', endkey: 'system.adapter.\u9999'}, function (err, doc) {
            if (err) {
                if (callback) callback ([]);
            } else {
                if (doc.rows.length === 0) {
                    if (callback) callback ([]);
                } else {
                    var res = [];
                    for (var i = 0; i < doc.rows.length; i++) {
                        res.push(doc.rows[i].value);
                    }
                    if (callback) callback (res);
                }
            }
        });
    }

    function buildComment(comment) {
        if (!comment) {
            return _('new');
        }
        if (typeof comment === 'string') return comment;
        var text = '';
        if (comment.add) {
            text += _('new');
        }
        if (comment.changed) {
            text += (text ? ', ' : '') + _('changed:') + ' ' + comment.changed;
        }
        if (comment.extended) {
            text += (text ? ', ' : '') + _('extended:') + ' ' + comment.extended;
        }
        if (comment.text) {
            text += (text ? ', ' : '') + comment.text;
        }
        return text;
    }

    // show list of found instances
    function step1() {
        var $instances = $('#step1_instances');
        var text = '';
        for (var i = 0; i < newInstances.length; i++) {
            text += '<tr>';
            text += '<td><input type="checkbox" data-id="' + i + '" /></td>';
            text += '<td>' + newInstances[i]._id.substring('system.adapter.'.length) + '</td>';
            text += '<td>' + buildComment(newInstances[i].comment) + '</td>';
        }
        $instances.html(text);
    }

    function load(settings, onChange) {
        $('.header').hide();
        // step 0

        $('.bottom-next').each(function () {
            $(this).button({
                label: $(this).data('title'),
                icons: {
                    primary: 'ui-icon-seek-next'
                }
            }).click(function () {
                showStep(currentStep + 1);
            });
        });

        showStep(0);

        socket.emit('subscribeStates',  'discovery.' + instance + '.*');
        socket.on('stateChange', function (id, state) {
            if (state && state.ack && id === 'discovery.' + instance + '.devicesProgress') {
                $('#step0_text').show().html(_('Lookup devices'));
                $('#step0_progressbar').show().progressbar({value: state.val});
            }
            if (state && state.ack && id === 'discovery.' + instance + '.servicesProgress') {
                $('#step0_text').show().html(_('Lookup services'));
                $('#step0_progressbar').show().progressbar({value: state.val});
            }
        });

        onChange(false);
    }

    function save(callback) {
        // do nothing
    }

    var steps = [
        step0,
        step1
    ];
</script>
<style>
    .wizard-header {
        width: calc(100% - 6px - 1rem);
        position: absolute;
        top: 0;
        height: 3rem;
        padding-left: 1rem;
    }
    .wizard-content {
        width: calc(100% - 26px);
        position: absolute;
        top: 3rem;
        height: calc(100% - 6rem - 20px);
        padding: 10px;
    }
    .wizard-footer {
        width: calc(100% - 16px);
        position: absolute;
        bottom: 0;
        height: calc(3rem - 10px);
        padding: 5px;
        background: black;
        text-align: right;
    }
    .wizard-table {
        width: 100%;
    }
    .wizard-table th {
        background: #338ce6;
        color: white;
        text-align: left;
    }
    .wizard-table tr:nth-child(even) {
        background: #CCC;
    }
    .wizard-table tr:nth-child(odd) {
        background: #FFF;
    }
</style>
</head>
<body>
    <div style="width: 100%; height: 100%" id="container">
        <div data-step="0" class="wizard-page" style="display: none">
            <div class="wizard-header ui-widget-header">
                <h3 class="translate">Step1 - Discover all possible devices</h3>
            </div>
            <div class="wizard-content">
                <div id="step0_help" class="translate">Press "Discover" to find devices in your network</div>
                <div id="step0_text" style="display: none"></div>
                <div id="step0_progressbar" style="display: none"></div>
            </div>
            <div class="wizard-footer">
                <button id="step0_discover" class="bottom-buttons" data-title="Discover"></button>
                <button id="step0_next" class="bottom-buttons bottom-next" data-title="Next"></button>
            </div>
        </div>
        <div data-step="1" class="wizard-page" style="display: none">
            <div class="wizard-header ui-widget-header">
                <h3 class="translate">Create instances automatically</h3>
            </div>
            <div class="wizard-content">
                <table class="wizard-table">
                    <thead>
                    <tr>
                        <th class="translate">Use</th>
                        <th class="translate">Instance</th>
                        <th class="translate">Description</th>
                    </tr>
                    </thead>
                    <tbody id="step1_instances">

                    </tbody>
                </table>
            </div>
            <div class="wizard-footer">
                <button id="step1_next" class="bottom-buttons bottom-next" data-title="Create instances"></button>
            </div>
        </div>

    </div>
</body>
</html>